---
- name: Set quay registry
  ansible.builtin.set_fact:
    code_red_breach_challenge_bootstrap_quay_registry_endpoint: "quay-{{
      guid }}.{{ openshift_cluster_ingress_domain }}"

- name: Install and configure cosign
  ansible.builtin.shell: |
    wget -q http://cli-server-{{ code_red_breach_challenge_bootstrap_trusted_artifact_signer_namespace }}.{{ openshift_cluster_ingress_domain }}/clients/linux/cosign-amd64.gz
    gunzip cosign-amd64.gz
    chmod a+x cosign-amd64
    sudo mv cosign-amd64 /usr/local/bin/cosign
    cosign login -u {{ code_red_breach_challenge_bootstrap_quay_admin_user }} -p {{
     code_red_breach_challenge_bootstrap_quay_admin_password }} {{
     code_red_breach_challenge_bootstrap_quay_registry_endpoint }}
  args:
    chdir: /tmp
  delegate_to: bastion

- name: Install and configure Tekton Chains
  block:
  - name: Setup cosign signing secret
    ansible.builtin.shell: |
      COSIGN_PASSWORD={{ code_red_breach_challenge_bootstrap_cosign_password }} \
      cosign generate-key-pair k8s://{{ code_red_breach_challenge_bootstrap_openshift_pipelines_namespace }}/signing-secrets
    args:
      chdir: /tmp
    delegate_to: bastion

  - name: Get signing secrets
    kubernetes.core.k8s_info:
      api_version: v1
      kind: Secret
      name: signing-secrets
      namespace: "{{ code_red_breach_challenge_bootstrap_openshift_pipelines_namespace }}"
    register: r_signing_secrets
    retries: 120
    delay: 10
    until:
    - r_signing_secrets is defined
    - r_signing_secrets.resources is defined
    - r_signing_secrets.resources | length > 0

  - name: Create vault secrets for Cosign (Encoded)
    kubernetes.core.k8s_exec:
      namespace: "{{ code_red_breach_challenge_bootstrap_vault_namespace }}"
      pod: vault-0
      command: "{{ item }}"
    loop:
    - "vault kv put kv/secrets/janusidp/cosign/key value={{ r_signing_secrets.resources[0].data['cosign.key'] }}"
    - "vault kv put kv/secrets/janusidp/cosign/password value={{ r_signing_secrets.resources[0].data['cosign.password'] }}"
    - "vault kv put kv/secrets/janusidp/cosign/pub value={{ r_signing_secrets.resources[0].data['cosign.pub'] }}"

  - name: Update Tekton Chains config
    kubernetes.core.k8s:
      state: present
      definition: "{{ lookup('template', 'tekton-config.yml.j2') | from_yaml }}"
