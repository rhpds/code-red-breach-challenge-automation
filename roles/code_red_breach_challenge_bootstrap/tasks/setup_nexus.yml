---
- name: Deploy Nexus Maven Repository
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'nexus-deployment.yml.j2') | from_yaml_all }}"

- name: Wait for Nexus deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: nexus
    namespace: nexus
  register: nexus_deployment
  retries: 60
  delay: 10
  until:
    - nexus_deployment.resources | length > 0
    - nexus_deployment.resources[0].status is defined
    - nexus_deployment.resources[0].status.availableReplicas is defined
    - nexus_deployment.resources[0].status.availableReplicas == 1

- name: Get Nexus route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: nexus
    namespace: nexus
  register: nexus_route

- name: Set Nexus URL
  ansible.builtin.set_fact:
    nexus_url: "https://{{ nexus_route.resources[0].spec.host }}"

- name: Get Nexus admin password from pod
  ansible.builtin.shell: |
    oc exec -n nexus $(oc get pod -n nexus -l app=nexus -o jsonpath='{.items[0].metadata.name}') -- cat /nexus-data/admin.password
  register: r_nexus_admin_password
  retries: 30
  delay: 10
  until: r_nexus_admin_password.rc == 0
  delegate_to: bastion

- name: Wait for Nexus API to be ready
  ansible.builtin.uri:
    url: "{{ nexus_url }}/service/rest/v1/status"
    method: GET
    status_code: 200
    validate_certs: false
  register: nexus_api_status
  retries: 30
  delay: 10
  until: nexus_api_status.status == 200

- name: Create Red Hat proxy repositories
  ansible.builtin.uri:
    url: "{{ nexus_url }}/service/rest/v1/repositories/maven/proxy"
    method: POST
    user: admin
    password: "{{ r_nexus_admin_password.stdout }}"
    force_basic_auth: yes
    body_format: json
    status_code: [201, 204]
    validate_certs: false
    body:
      name: "{{ item.name }}"
      online: true
      storage:
        blobStoreName: default
        strictContentTypeValidation: true
      proxy:
        remoteUrl: "{{ item.url }}"
        contentMaxAge: 1440
        metadataMaxAge: 1440
      negativeCache:
        enabled: true
        timeToLive: 1440
      httpClient:
        blocked: false
        autoBlock: true
      maven:
        versionPolicy: RELEASE
        layoutPolicy: STRICT
  loop:
    - name: redhat-ga
      url: https://maven.repository.redhat.com/ga/
    - name: redhat-ea
      url: https://maven.repository.redhat.com/earlyaccess/all/

- name: Update maven-public group to include Red Hat repositories
  ansible.builtin.uri:
    url: "{{ nexus_url }}/service/rest/v1/repositories/maven/group/maven-public"
    method: PUT
    user: admin
    password: "{{ r_nexus_admin_password.stdout }}"
    force_basic_auth: yes
    body_format: json
    status_code: [200, 204]
    validate_certs: false
    body:
      name: maven-public
      online: true
      storage:
        blobStoreName: default
        strictContentTypeValidation: true
      group:
        memberNames:
          - maven-releases
          - maven-snapshots
          - maven-central
          - redhat-ga
          - redhat-ea

- name: Display Nexus information
  ansible.builtin.debug:
    msg:
      - "Nexus deployed successfully!"
      - "External URL: {{ nexus_url }}"
      - "Internal URL: http://nexus.nexus.svc.cluster.local:8081"
      - "Maven Mirror URL: http://nexus.nexus.svc.cluster.local:8081/repository/maven-public/"
      - ""
      - "Admin Credentials:"
      - "  Username: admin"
      - "  Password: {{ r_nexus_admin_password.stdout }}"
      - ""
      - "Red Hat repositories configured:"
      - "  - redhat-ga: https://maven.repository.redhat.com/ga/"
      - "  - redhat-ea: https://maven.repository.redhat.com/earlyaccess/all/"
