---
- name: Check if helm is installed
  ansible.builtin.command: command -v helm
  register: git_helm
  ignore_errors: true

- name: Install helm if not present
  when: git_helm.rc != 0
  ansible.builtin.shell: |
    curl -LO https://get.helm.sh/helm-{{ code_red_breach_challenge_bootstrap_helm_cli_version }}-linux-amd64.tar.gz
    tar -zxvf helm-{{ code_red_breach_challenge_bootstrap_helm_cli_version }}-linux-amd64.tar.gz
    mv linux-amd64/helm /usr/local/bin/helm
  args:
    chdir: /tmp
  become: true

- name: Create kube config
  ansible.builtin.shell: |
    oc login --token {{ openshift_cluster_admin_token }} --server {{ openshift_api_url }} --insecure-skip-tls-verify
  delegate_to: bastion

# - name: Setup Vault
#   ansible.builtin.include_tasks:
#     file: ./setup_vault.yml

# - name: Setup External Secrets Operator
#   ansible.builtin.include_tasks:
#     file: ./setup_external_secrets.yml

- name: Setup Quay
  ansible.builtin.include_tasks:
    file: ./setup_quay.yml

- name: Setup External Secrets Operator
  ansible.builtin.include_tasks:
    file: ./setup_external_secret_entries.yml

- name: Setup Tekton Chains
  ansible.builtin.include_tasks:
    file: ./setup_tekton_chains.yml

- name: Setup CycloneDX Repository
  ansible.builtin.include_tasks:
    file: ./setup_cyclonedx_repo_server.yml

- name: Setup remote app
  block:
  - ansible.builtin.include_tasks: setup_remote_app.yml
  delegate_to: bastion

- name: Setup job runner
  ansible.builtin.include_tasks:
    file: ./setup_job_runner.yml