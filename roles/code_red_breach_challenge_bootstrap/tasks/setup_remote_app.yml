---
- name: Get ripper-ssh service
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: ripper-ssh
    namespace: "{{ sandbox_openshift_namespace }}"
    host: "{{ sandbox_openshift_api_url }}"
    api_key: "{{ sandbox_openshift_api_key }}"
    validate_certs: false
  register: r_ripper_ssh_service

- name: Set ripper IP
  ansible.builtin.set_fact:
    _ripper_ssh_port: "{{ r_ripper_ssh_service.resources[0].spec.ports[0].nodePort | default(0) }}"

- name: Fetch SSH key from bastion
  ansible.builtin.fetch:
    src: "{{ cloud_user_ssh_private_key_path }}"
    dest: /tmp/id_rsa
  delegate_to: bastion
  become: true

- name: Fix SSH key permissions
  ansible.builtin.file:
    path: /tmp/id_rsa
    mode: 0600"

- name: Add ripper instance to ansible inventory
  ansible.builtin.add_host:
    name: ripper
    groups: ripper_servers
    ansible_host: "{{ bastion_ansible_host }}"
    ansible_port: "{{ _ripper_ssh_port }}"
    ansible_user: cloud-user
    ansible_ssh_private_key_file: /tmp/id_rsa
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

- block:
  - name: Test connection to ripper
    ansible.builtin.ping:
    delegate_to: ripper

  - name: Install podman compose and create compose file
    become: true
    ansible.builtin.shell: |
      dnf install -y podman python3-pip
      pip3 install podman-compose python-dotenv
      cat <<EOF > /root/compose.yml
      version: "3.8"

      services:
        ripper:
          image: {{ code_red_breach_challenge_bootstrap_remote_ripper_image }}
          container_name: ripper
          ports:
            - "8500:8080"
          environment:
            - JAVA_APP_JAR=/deployments/quarkus-run.jar
          restart: unless-stopped
      EOF
    delegate_to: ripper

  - name: Create the ripper systemd service
    become: true
    ansible.builtin.template:
      src: ripper-service.yml.j2
      dest: /etc/systemd/system/ripper.service
      owner: root
      group: root
      mode: u=rw,g=r,o=r
    delegate_to: ripper

  - name: Enable ripper systemd service
    become: true
    ansible.builtin.service:
      name: ripper.service
      enabled: true
      state: started
    delegate_to: ripper

  environment:
    ANSIBLE_HOST_KEY_CHECKING: "False"
